<!DOCTYPE html>
<html lang="polish" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>O problemach z errno słów kilka - Krzysiek Witkowicz</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/posts/2017/06/07/errno.html">

        <meta name="author" content="Krzysiek Witkowicz" />
        <meta name="keywords" content="c,linux,kernel" />
        <meta name="description" content="W ramach przypomnienia Błąd jest sygnalizowany poprzez zwracaną wartość funkcji oraz opisywany poprzez zmienną globalną errno. Informację o błędzie funkcje przekazują odpowiednią wartością kodu powrotu (zazwyczaj -1, lub, dla funkcji zwracających wskaźnik, wartością NULL), natomiast wartość ta nie dostarcza żadnych informacji na temat przyczyn jej wystąpienia. W tym celu należy …" />

        <meta property="og:site_name" content="Krzysiek Witkowicz" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="O problemach z errno słów kilka"/>
        <meta property="og:url" content="/posts/2017/06/07/errno.html"/>
        <meta property="og:description" content="W ramach przypomnienia Błąd jest sygnalizowany poprzez zwracaną wartość funkcji oraz opisywany poprzez zmienną globalną errno. Informację o błędzie funkcje przekazują odpowiednią wartością kodu powrotu (zazwyczaj -1, lub, dla funkcji zwracających wskaźnik, wartością NULL), natomiast wartość ta nie dostarcza żadnych informacji na temat przyczyn jej wystąpienia. W tym celu należy …"/>
        <meta property="article:published_time" content="2017-06-07" />
            <meta property="article:section" content="programowanie" />
            <meta property="article:tag" content="c" />
            <meta property="article:tag" content="linux" />
            <meta property="article:tag" content="kernel" />
            <meta property="article:author" content="Krzysiek Witkowicz" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.cosmo.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/solarizeddark.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>



</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Krzysiek Witkowicz            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="/category/programowanie.html">Programowanie</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/posts/2017/06/07/errno.html"
                       rel="bookmark"
                       title="Permalink to O problemach z errno słów kilka">
                        O problemach z errno słów kilka
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-06-07T21:00:00+02:00"> śro 07 czerwca 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="/category/programowanie.html">programowanie</a>


<span class="label label-default">Tags</span>
	<a href="/tag/c.html">c</a>
        /
	<a href="/tag/linux.html">linux</a>
        /
	<a href="/tag/kernel.html">kernel</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <div class="section" id="w-ramach-przypomnienia">
<h2>W ramach przypomnienia</h2>
<p>Błąd jest sygnalizowany poprzez zwracaną wartość funkcji oraz opisywany poprzez zmienną
globalną <code class="c"><span class="n">errno</span></code>. Informację o błędzie funkcje przekazują odpowiednią wartością kodu powrotu (zazwyczaj -1, lub,
dla funkcji zwracających wskaźnik, wartością NULL), natomiast wartość ta nie dostarcza żadnych informacji na temat przyczyn
jej wystąpienia. W tym celu należy skorzystać ze zmiennej <code class="c"><span class="n">errno</span></code>.</p>
</div>
<div class="section" id="problem-1">
<h2>Problem 1</h2>
<p>Mało kto pamięta, że wartość zmiennej errno może zmodyfikować dowolne wywołanie funkcji bibliotecznej lub systemowej.
Rozważmy taki oto lekko idiotyczny, i, co ważniejsze, <strong>błędny</strong>, fragment kodu, którego celem jest wyłapanie nieprawidłowego
deskryptora pliku.</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span> <span class="cm">/* fake file descriptor */</span>
        <span class="kt">int</span> <span class="n">log_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"my.log"</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_WRONLY</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
                <span class="n">write</span><span class="p">(</span><span class="n">log_fd</span><span class="p">,</span><span class="s">"Problem with close!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="mi">19</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EBADF</span><span class="p">){</span>
                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Bad file descriptor!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span><span class="p">{</span>
                        <span class="n">perror</span><span class="p">(</span><span class="s">"close"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">close</span><span class="p">(</span><span class="n">log_fd</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Po skompilowaniu i uruchomieniu powinniśmy, zgodnie z oczekiwaniami, dowiedzieć się o niewłaściwym deskryptorze pliku:</p>
<div class="highlight"><pre><span></span>pi@raspberrypi:~/c/err $ ./test1
Bad file descriptor!
pi@raspberrypi:~/c/err $ tail my.log
Problem with close!
pi@raspberrypi:~/c/err $
</pre></div>
<p>Dlaczego więc ten program jest błędny? Aby to sprawdzić, spróbujmy lekko go zmodyfikować, wywołując błąd w funkcji <code class="c"><span class="n">write</span></code>:</p>
<div class="highlight"><pre><span></span><span class="n">write</span><span class="p">(</span><span class="n">log_fd</span><span class="p">,</span><span class="s">"Problem with close!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="o">-</span><span class="mi">20</span><span class="p">);</span>
</pre></div>
<p>Tym razem informacja o błędzie jest inna:</p>
<div class="highlight"><pre><span></span>pi@raspberrypi:~/c/err $ ./test2
close: Bad address
pi@raspberrypi:~/c/err $
</pre></div>
<p>Co się stało? Otóż funkcja <code class="c"><span class="n">write</span></code> otrzymawszy błędną wartość parametru count, ustawiła <code class="c"><span class="n">errno</span></code> na wartość EFAULT.
My tymczasem cały czas zakładamy, że <code class="c"><span class="n">errno</span></code> zostało ustawione przez funkcję <code class="c"><span class="n">close</span></code>.
Jak uniknąć takiego błędu? Należy zachować wartość <code class="c"><span class="n">errno</span></code> pomiędzy wywołaniami funkcji:</p>
<div class="highlight"><pre><span></span><span class="c1">#include&lt;stdio.h&gt;</span>
<span class="c1">#include&lt;unistd.h&gt;</span>
<span class="c1">#include&lt;errno.h&gt;</span>
<span class="c1">#include&lt;fcntl.h&gt;</span>

extern int errno<span class="p">;</span>
FILE * f<span class="p">;</span>

int main<span class="o">(</span>int argc, char * argv<span class="o">[])</span>
<span class="o">{</span>
       int <span class="nv">fd</span> <span class="o">=</span> -3<span class="p">;</span> /* fake file descriptor */
       int <span class="nv">log_fd</span> <span class="o">=</span> open<span class="o">(</span><span class="s2">"my.log"</span>, O_CREAT<span class="p">|</span>O_WRONLY, S_IRUSR<span class="p">|</span>S_IWUSR<span class="o">)</span><span class="p">;</span>

       <span class="k">if</span><span class="o">(</span>close<span class="o">(</span>fd<span class="o">)</span> <span class="o">==</span> -1<span class="o">){</span>
               const int <span class="nv">err</span> <span class="o">=</span> errno<span class="p">;</span>
               write<span class="o">(</span>log_fd,<span class="s2">"Problem with close\n"</span>,-20<span class="o">)</span><span class="p">;</span>
               <span class="k">if</span> <span class="o">(</span><span class="nv">err</span> <span class="o">==</span> EBADF<span class="o">){</span>
                       fprintf<span class="o">(</span>stderr, <span class="s2">"Bad file descriptor!\n"</span><span class="o">)</span><span class="p">;</span>
               <span class="o">}</span>
               <span class="k">else</span><span class="o">{</span>
                       perror<span class="o">(</span><span class="s2">"close"</span><span class="o">)</span><span class="p">;</span>
               <span class="o">}</span>
               close<span class="o">(</span>log_fd<span class="o">)</span><span class="p">;</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
<span class="o">}</span>
</pre></div>
<p>Tym razem, po skompilowaniu i uruchomieniu programu, dowiadujemy się o problemie z deskryptorem pliku:</p>
<div class="highlight"><pre><span></span>pi@raspberrypi:~/c/err $ ./test3
Bad file descriptor!
</pre></div>
<p>Błędy tego typu nie są powszechne, ale kiedy się już zdarzą, znalezienie ich przyczyny potrafi kosztować sporo wysiłku.</p>
</div>
<div class="section" id="problem-2">
<h2>Problem 2</h2>
<p>Czy poniższy kod jest poprawny?</p>
<div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"strtol"</span><span class="p">);</span>
</pre></div>
<p>Otóż nie, gdyż istnieją funkcje (jak powyższa), dla których cały zakres zwracanych wartości jest poprawny. W takiej sytuacji należy pamiętać o
wyzerowaniu zmiennej <code class="c"><span class="n">errno</span></code> przed zawołaniem funkcji, a po jej użyciu, ponownym sprawdzeniu <code class="c"><span class="n">errno</span></code>:</p>
<div class="highlight"><pre><span></span><span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">errno</span><span class="p">)</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"strtol"</span><span class="p">);</span>
</pre></div>
<p>Skoro już jesteśmy przy <code class="c"><span class="n">strtol</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span></code>, można wspomnieć o jeszcze jej jednej, ciekawej właściwości.
Mianiowicie funkcja ta ustawia <code class="c"><span class="n">errno</span></code> jedynie w sytuacji przepełnienia (na kod <strong>ERANGE</strong>). Natomiast by stwierdzić błąd parsowania
przekazanego napisu, należy sprawdzić wskaźnik <code class="c"><span class="n">endptr</span></code>:</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"foobar"</span><span class="p">;</span>
<span class="kt">long</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>

<span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span>
       <span class="n">perror</span><span class="p">(</span><span class="s">"strtol"</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">str</span><span class="p">)</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"No conversion"</span><span class="p">);</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">"The whole string has been converted"</span><span class="p">);</span>
<span class="k">else</span>
       <span class="nf">printf</span><span class="p">(</span><span class="s">"Ptr point to unconverted rest of the string"</span><span class="p">);</span>
</pre></div>
<p>Jak łatwo można się przekonać, dla</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"foobar"</span><span class="p">;</span>
</pre></div>
<p>otrzymamy komunikat <strong>"No conversion"</strong>. Dla:</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"111fobar"</span><span class="p">;</span>
</pre></div>
<p>wynikiem będzie komunikat <strong>"Ptr point to unconverted rest of the string"</strong>. Natomiast gdy będziemy chcieli sparsować zbyt
dużą wartość:</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"9999999999999999"</span><span class="p">;</span>
</pre></div>
<p><code class="c"><span class="n">errno</span></code> zostanie ustawione na <strong>ERANGE</strong> o czym program nas poinformuje komunikatem <strong>"strtol: Numerical result out of range"</strong></p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="http://github.com/kwitkowicz"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="/posts/2020/04/07/value-bad.html">Dlaczego @Value to zło</a></li>
    <li class="list-group-item"><a href="/posts/2017/08/20/lseek.html">lseek</a></li>
    <li class="list-group-item"><a href="/posts/2017/06/07/errno.html">O problemach z errno słów kilka</a></li>
    <li class="list-group-item"><a href="/posts/2017/03/14/rpi-lkm-part-3.html">Raspberry Pi: moduły jądra - część 3</a></li>
    <li class="list-group-item"><a href="/posts/2017/03/01/email-python.html">Email w pythonie</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group " id="tags">
    <li class="list-group-item tag-1">
      <a href="/tag/raspberry-pi.html">raspberry pi</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="/tag/kernel.html">kernel</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="/tag/c.html">c</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/linux.html">linux</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/email.html">email</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/python.html">python</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/java.html">java</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/spring-boot.html">spring-boot</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/spring.html">spring</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://getpelican.com/" target="_blank">Pelican</a>
    </li>
    <li class="list-group-item">
      <a href="http://python.org/" target="_blank">Python.org</a>
    </li>
    <li class="list-group-item">
      <a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Krzysiek Witkowicz
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.polish"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.polish">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>




</body>
</html>