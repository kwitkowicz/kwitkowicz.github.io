<!DOCTYPE html>
<html lang="polish" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Email w pythonie - Krzysiek Witkowicz</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/posts/2017/03/01/email-python.html">

        <meta name="author" content="Krzysiek Witkowicz" />
        <meta name="keywords" content="python,email" />
        <meta name="description" content="Email jest jedną z popularniejszych form komunikacji, a Python dostarcza w bibliotece standardowej szereg rozwiązań umożliwiających łatwą pracę z pocztą elektroniczną. Na przykładzie gmaila postaram się pokazać, jak napisać, wysłać i odebrać wiadomość email. SMTP SMTP czyli Simple Mail Transfer Protocol jest standardowym protokołem transmisji poczty w internecie. Choć serwery …" />

        <meta property="og:site_name" content="Krzysiek Witkowicz" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Email w pythonie"/>
        <meta property="og:url" content="/posts/2017/03/01/email-python.html"/>
        <meta property="og:description" content="Email jest jedną z popularniejszych form komunikacji, a Python dostarcza w bibliotece standardowej szereg rozwiązań umożliwiających łatwą pracę z pocztą elektroniczną. Na przykładzie gmaila postaram się pokazać, jak napisać, wysłać i odebrać wiadomość email. SMTP SMTP czyli Simple Mail Transfer Protocol jest standardowym protokołem transmisji poczty w internecie. Choć serwery …"/>
        <meta property="article:published_time" content="2017-03-01" />
            <meta property="article:section" content="programowanie" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="email" />
            <meta property="article:author" content="Krzysiek Witkowicz" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.cosmo.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/solarizeddark.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>



</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Krzysiek Witkowicz            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="/category/programowanie.html">Programowanie</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/posts/2017/03/01/email-python.html"
                       rel="bookmark"
                       title="Permalink to Email w pythonie">
                        Email w pythonie
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-03-01T22:00:00+01:00"> śro 01 marca 2017</time>
    </span>



        <span class="label label-default">Category</span>
        <a href="/category/programowanie.html">programowanie</a>


<span class="label label-default">Tags</span>
	<a href="/tag/python.html">python</a>
        /
	<a href="/tag/email.html">email</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Email jest jedną z popularniejszych form komunikacji, a Python dostarcza w bibliotece standardowej szereg rozwiązań
umożliwiających łatwą pracę z pocztą elektroniczną. Na przykładzie gmaila postaram się pokazać, jak napisać, wysłać i
odebrać wiadomość email.</p>
<div class="section" id="smtp">
<h2>SMTP</h2>
<p>SMTP czyli Simple Mail Transfer Protocol jest standardowym protokołem transmisji poczty w internecie. Choć serwery pocztowe
wykorzystują go zarówno do wysyłania, jak i odbierania wiadomości, aplikacje klienckie korzystają z SMTP do wysyłania
emaili.
Poniższy program pokazuje próbę prostej komunikacji z serwerem poczty wychodzącej:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">import</span> <span class="nn">email.mime.multipart</span>
<span class="kn">import</span> <span class="nn">email.mime.text</span>

<span class="n">SMTP_SERVER</span> <span class="o">=</span> <span class="s1">'gmail-smtp-in.l.google.com'</span>
<span class="n">SMTP_PORT</span> <span class="o">=</span> <span class="mi">25</span>

<span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">multipart</span><span class="o">.</span><span class="n">MIMEMultipart</span><span class="p">()</span>
<span class="n">message</span><span class="p">[</span><span class="s1">'TO'</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter 'To' email adress: "</span><span class="p">)</span>
<span class="n">message</span><span class="p">[</span><span class="s1">'FROM'</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter 'From' email address: "</span><span class="p">)</span>
<span class="n">message</span><span class="p">[</span><span class="s1">'Subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter subject of your email: "</span><span class="p">)</span>

<span class="n">message_part</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">MIMEText</span><span class="p">(</span><span class="s1">'text'</span><span class="p">,</span> <span class="s1">'plain'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter your message: "</span><span class="p">)</span>
<span class="n">message_part</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">message_part</span><span class="p">)</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">SMTP_SERVER</span><span class="p">,</span> <span class="n">SMTP_PORT</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">'FROM'</span><span class="p">],</span> <span class="n">message</span><span class="p">[</span><span class="s1">'TO'</span><span class="p">],</span> <span class="n">message</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
    <span class="n">session</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="k">except</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPHeloError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">"Server didn't reply properly to helo"</span>
    <span class="nb">print</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span>
<span class="k">except</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPRecipientsRefused</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">"Server rejected recipients"</span>
    <span class="nb">print</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span>
<span class="k">except</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPSenderRefused</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">"Server didn't accept From address"</span>
    <span class="nb">print</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span>
<span class="k">except</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPDataError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">"Unexpected error"</span>
    <span class="nb">print</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span>
<span class="k">except</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPServerDisconnected</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">"Connection closed"</span>
    <span class="nb">print</span> <span class="n">ex</span><span class="o">.</span><span class="n">message</span>
</pre></div>
<p>Próba uruchomienia kończy się, niestety, porażką:</p>
<div class="highlight"><pre><span></span>Enter <span class="s1">'To'</span> email adress: username@gmail.com
Enter <span class="s1">'From'</span> email address: username@gmail.com
Enter subject of your email: Test
Enter your message: Hello World!
Connection closed
Connection unexpectedly closed

Process finished with <span class="nb">exit</span> code <span class="m">0</span>
</pre></div>
<p>Do znalezienia błędu wykorzystamy metodę <code class="pyth python"><span class="n">set_debug_level</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></code> jaką udostępnia nam klasa <code class="pyth python"><span class="n">SMTP</span></code>.
Pozwoli ona podejrzeć wszystkie informacje, zarówno wysyłane do serwera jak i od niego otrzymane:</p>
<div class="highlight"><pre><span></span>Enter <span class="s1">'To'</span> email adress: username@gmail.com
Enter <span class="s1">'From'</span> email address: username@gmail.com
Enter subject of your email: Test
Enter your message: Hello World!
send: <span class="s1">'ehlo [192.168.56.1]\r\n'</span>
reply: <span class="s1">'250-mx.google.com at your service, [46.215.215.74]\r\n'</span>
reply: <span class="s1">'250-SIZE 157286400\r\n'</span>
reply: <span class="s1">'250-8BITMIME\r\n'</span>
reply: <span class="s1">'250-STARTTLS\r\n'</span>
reply: <span class="s1">'250-ENHANCEDSTATUSCODES\r\n'</span>
reply: <span class="s1">'250-PIPELINING\r\n'</span>
reply: <span class="s1">'250 SMTPUTF8\r\n'</span>
reply: retcode <span class="o">(</span><span class="m">250</span><span class="o">)</span><span class="p">;</span> Msg: mx.google.com at your service, <span class="o">[</span><span class="m">46</span>.215.215.74<span class="o">]</span>
SIZE <span class="m">157286400</span>
8BITMIME
STARTTLS
ENHANCEDSTATUSCODES
PIPELINING
SMTPUTF8
send: <span class="s1">'mail FROM:&lt;username@gmail.com&gt; size=340\r\n'</span>
reply: <span class="s1">'250 2.1.0 OK 88si2341819lfx.293 - gsmtp\r\n'</span>
reply: retcode <span class="o">(</span><span class="m">250</span><span class="o">)</span><span class="p">;</span> Msg: <span class="m">2</span>.1.0 OK 88si2341819lfx.293 - gsmtp
send: <span class="s1">'rcpt TO:&lt;username@gmail.com&gt;\r\n'</span>
reply: <span class="s1">'250 2.1.5 OK 88si2341819lfx.293 - gsmtp\r\n'</span>
reply: retcode <span class="o">(</span><span class="m">250</span><span class="o">)</span><span class="p">;</span> Msg: <span class="m">2</span>.1.5 OK 88si2341819lfx.293 - gsmtp
send: <span class="s1">'data\r\n'</span>
reply: <span class="s1">'354  Go ahead 88si2341819lfx.293 - gsmtp\r\n'</span>
reply: retcode <span class="o">(</span><span class="m">354</span><span class="o">)</span><span class="p">;</span> Msg: Go ahead 88si2341819lfx.293 - gsmtp
data: <span class="o">(</span><span class="m">354</span>, <span class="s1">'Go ahead 88si2341819lfx.293 - gsmtp'</span><span class="o">)</span>
send: <span class="s1">'Content-Type: multipart/mixed; boundary="===============1757486702=="\r\nMIME-Version: 1.0\r\nTO: username@gmail.com\r\nFROM: username@gmail.com\r\nSubject: Test\r\n\r\n--===============1757486702==\r\nContent-Type: text/plain; charset="us-ascii"\r\nMIME-Version: 1.0\r\nContent-Transfer-Encoding: 7bit\r\n\r\nHello World!\r\n--===============1757486702==--\r\n.\r\n'</span>
reply: <span class="s1">'421-4.7.0 [46.215.215.74      15] Our system has detected that this message is\r\n'</span>
reply: <span class="s1">'421-4.7.0 suspicious due to the very low reputation of the sending IP address.\r\n'</span>
reply: <span class="s1">'421-4.7.0 To protect our users from spam, mail sent from your IP address has\r\n'</span>
reply: <span class="s1">'421-4.7.0 been temporarily rate limited. Please visit\r\n'</span>
reply: <span class="s1">'421 4.7.0  https://support.google.com/mail/answer/188131 for more information. 88si2341819lfx.293 - gsmtp\r\n'</span>
reply: retcode <span class="o">(</span><span class="m">421</span><span class="o">)</span><span class="p">;</span> Msg: <span class="m">4</span>.7.0 <span class="o">[</span><span class="m">46</span>.215.215.74      <span class="m">15</span><span class="o">]</span> Our system has detected that this message is
<span class="m">4</span>.7.0 suspicious due to the very low reputation of the sending IP address.
<span class="m">4</span>.7.0 To protect our users from spam, mail sent from your IP address has
<span class="m">4</span>.7.0 been temporarily rate limited. Please visit
<span class="m">4</span>.7.0  https://support.google.com/mail/answer/188131 <span class="k">for</span> more information. 88si2341819lfx.293 - gsmtp
data: <span class="o">(</span><span class="m">421</span>, <span class="s1">'4.7.0 [46.215.215.74      15] Our system has detected that this message is\n4.7.0 suspicious due to the very low reputation of the sending IP address.\n4.7.0 To protect our users from spam, mail sent from your IP address has\n4.7.0 been temporarily rate limited. Please visit\n4.7.0  https://support.google.com/mail/answer/188131 for more information. 88si2341819lfx.293 - gsmtp'</span><span class="o">)</span>
send: <span class="s1">'rset\r\n'</span>
Connection closed
Connection unexpectedly closed: <span class="o">[</span>Errno <span class="m">10053</span><span class="o">]</span> Nawiązane połączenie zostało przerwane przez oprogramowanie zainstalowane w komputerze-hoťcie
</pre></div>
<p>Jak widać serwer zerwał połączenie ze względów bezpieczeństwa. Trudno zresztą się dziwić, pozwolenie na
wysyłanie wiadomości bez choćby podstawowej autoryzacji użytkownika byłoby dużym zagrożeniem.
Spróbujemy więc zabezpieczyć naszą transmisję poprzez TLS <code class="pyth python"><span class="n">SMTP</span><span class="o">.</span><span class="n">starttls</span><span class="p">([</span><span class="n">keyfile</span><span class="p">[,</span> <span class="n">certfile</span><span class="p">])</span></code> oraz zautoryzować się loginem
i hasłem do konta <code class="pyth python"><span class="n">SMTP</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></code>:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">email.mime.multipart</span>
<span class="kn">import</span> <span class="nn">email.mime.text</span>

<span class="n">SMTP_SERVER</span> <span class="o">=</span> <span class="s1">'smtp.gmail.com'</span>
<span class="n">SMTP_PORT</span> <span class="o">=</span> <span class="mi">587</span>

<span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">multipart</span><span class="o">.</span><span class="n">MIMEMultipart</span><span class="p">()</span>
<span class="n">message</span><span class="p">[</span><span class="s1">'TO'</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter 'To' email adress: "</span><span class="p">)</span>
<span class="n">message</span><span class="p">[</span><span class="s1">'FROM'</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter 'From' email address: "</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="s1">'Enter password: ")</span>
<span class="n">message</span><span class="p">[</span><span class="s1">'Subject'</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter subject of your email: "</span><span class="p">)</span>

<span class="n">message_part</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">MIMEText</span><span class="p">(</span><span class="s1">'text'</span><span class="p">,</span> <span class="s1">'plain'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">"Enter your message: "</span><span class="p">)</span>
<span class="n">message_part</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">message_part</span><span class="p">)</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">SMTP_SERVER</span><span class="p">,</span> <span class="n">SMTP_PORT</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">set_debuglevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
<span class="n">server</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
<span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">'FROM'</span><span class="p">],</span> <span class="n">password</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">'FROM'</span><span class="p">],</span> <span class="n">message</span><span class="p">[</span><span class="s1">'TO'</span><span class="p">],</span> <span class="n">message</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
<span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
<p>Niestety, próba wysłania wiadomości kończy się kolejnym błędem:</p>
<div class="highlight"><pre><span></span>smtplib.SMTPAuthenticationError: <span class="o">(</span><span class="m">534</span>, <span class="s1">'5.7.9 Application-specific password required. Learn more at\n5.7.9  https://support.google.com/mail/?p=InvalidSecondFactor m18sm1211864ljb.8 - gsmtp'</span><span class="o">)</span>
</pre></div>
<p>Krótka lektura informacji spod wskazanego w opisie błędu linka wyjaśnia, że problem wynika z dwuskładnikowego uwierzytelniania
i jego rozwiązaniem jest zautoryzowanie się hasłem wygenerowanym z poziomu ustawień konta. Postępując zgodnie z instrukcją
otrzymamy ciąg 16-tu znaków, który zastąpi nam nasze hasło do konta. Kolejna próba kończy się sukcesem:</p>
<div class="highlight"><pre><span></span>send: <span class="s1">'quit\r\n'</span>
reply: <span class="s1">'221 2.0.0 closing connection 75sm2003575lfy.27 - gsmtp\r\n'</span>
reply: retcode <span class="o">(</span><span class="m">221</span><span class="o">)</span><span class="p">;</span> Msg: <span class="m">2</span>.0.0 closing connection 75sm2003575lfy.27 - gsmtp
</pre></div>
<p>Skoro umiemy już wysłać email, spróbujmy go rozbudować. Stwórzmy np. wiadomość w HTMLu dodając jednocześnie alternatywny czysty tekst:</p>
<div class="highlight"><pre><span></span><span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">multipart</span><span class="o">.</span><span class="n">MIMEMultipart</span><span class="p">(</span><span class="s1">'alternative'</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">"Hello!</span><span class="se">\n</span><span class="s2">What's your name?"</span>
<span class="n">html</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2"> &lt;head&gt;&lt;/head&gt;</span>
<span class="s2"> &lt;body&gt;</span>
<span class="s2">   &lt;h1&gt;Hello!&lt;/h1&gt;&lt;br&gt;</span>
<span class="s2">   &lt;p&gt;What's your name?&lt;/p&gt;</span>
<span class="s2"> &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">"""</span>
<span class="n">part_plain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">MIMEText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">'plain'</span><span class="p">)</span>
<span class="n">part_html</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">MIMEText</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">'html'</span><span class="p">)</span>

<span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">part_plain</span><span class="p">)</span>
<span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">part_html</span><span class="p">)</span>
</pre></div>
<p>Analogicznie możemy dołączyć plik binarny, choćby to <a class="reference external" href="https://commons.wikimedia.org/wiki/File:%22A_Mogul_Trooper%22_(James_S._Virtue_Co.,_London,_1858).jpg#">zdjęcie</a>:</p>
<div class="highlight"><pre><span></span><span class="n">message_part</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">MIMEText</span><span class="p">(</span><span class="s1">'text'</span><span class="p">,</span> <span class="s1">'plain'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s2">"Look at this is very interesting photo."</span>
<span class="n">message_part</span><span class="o">.</span><span class="n">set_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">message_part</span><span class="p">)</span>

<span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'trooper.jpg'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
<span class="n">image_part</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">mime</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">MIMEImage</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">message</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">image_part</span><span class="p">)</span>

<span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="pop3">
<h2>POP3</h2>
<p>Do pobrania wiadomości ze skrzynki może być wykorzystany protokół POP3. Dostęp do niego daje nam moduł <code class="pyth python"><span class="n">poplib</span></code>,
udostępniający klasy <code class="pyth python"><span class="n">POP3</span><span class="p">(</span><span class="n">host</span><span class="p">[,</span> <span class="n">port</span><span class="p">[,</span> <span class="n">timeout</span><span class="p">]])</span></code> oraz <code class="pyth python"><span class="n">POP3_SSL</span><span class="p">(</span><span class="n">host</span><span class="p">[,</span> <span class="n">port</span><span class="p">[,</span> <span class="n">keyfile</span><span class="p">[,</span> <span class="n">certfile</span><span class="p">]]])</span></code>.
Wykorzystamy oczywiście wersję z szyfrowaniem - taki
serwer nasłuchuje domyślnie na porcie 995 (w odróżnieniu od zwykłego POP3 nasłuchującego na porcie 110). Jest to o tyle
ważne, że 'zwykły' POP w ogóle nie szyfruje transmisji - dane, również hasło, przesyłane są czystym tekstem (chyba że
skorzystamy z komendy APOP).</p>
<p>Spróbujmy więc na początek połączyć się z serwerem:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">poplib</span>
<span class="kn">import</span> <span class="nn">getpass</span>

<span class="n">POP3_SERVER</span> <span class="o">=</span> <span class="s1">'pop.googlemail.com'</span>
<span class="n">POP3_PORT</span> <span class="o">=</span> <span class="s1">'995'</span>

<span class="n">username</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s1">'Enter your email'</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s1">'Enter your password'</span><span class="p">)</span>

<span class="n">mailbox</span> <span class="o">=</span> <span class="n">poplib</span><span class="o">.</span><span class="n">POP3_SSL</span><span class="p">(</span><span class="n">POP3_SERVER</span><span class="p">,</span> <span class="n">POP3_PORT</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">pass_</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

<span class="n">mailbox</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
<p>i od razu spodziewajmy się znanego już błędu:</p>
<div class="highlight"><pre><span></span>poplib.error_proto: -ERR <span class="o">[</span>AUTH<span class="o">]</span> Application-specific password required: https://support.google.com/accounts/answer/185833
</pre></div>
<p>Zastąpienie hasła wygenerowanym wcześniej 'App password' rozwiązuje problem.
Spróbujmy więc dowiedzieć się od serwera czegoś więcej:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">poplib</span>

<span class="n">POP3_SERVER</span> <span class="o">=</span> <span class="s1">'pop.googlemail.com'</span>
<span class="n">POP3_PORT</span> <span class="o">=</span> <span class="s1">'995'</span>
<span class="n">APP_PASSWORD</span><span class="o">=</span><span class="s1">''</span>

<span class="n">username</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s1">'Enter your email'</span><span class="p">)</span>

<span class="n">mailbox</span> <span class="o">=</span> <span class="n">poplib</span><span class="o">.</span><span class="n">POP3_SSL</span><span class="p">(</span><span class="n">POP3_SERVER</span><span class="p">,</span> <span class="n">POP3_PORT</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">set_debuglevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">pass_</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="n">mailbox_status</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
<span class="nb">print</span> <span class="s2">"Message count </span><span class="si">{}</span><span class="s2">, mailbox size </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mailbox</span><span class="o">.</span><span class="n">stat</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">stat</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">rset</span><span class="p">()</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span>Message count <span class="m">219</span>, mailbox size <span class="m">204595639</span>
<span class="o">(</span><span class="s1">'+OK 219 messages (204595639 bytes)'</span>, <span class="o">[</span><span class="s1">'1 17367'</span>, <span class="s1">'2 43517'</span>, <span class="s1">'3 17122'</span>, <span class="o">(</span>...<span class="o">)</span> , <span class="s1">'219 133436'</span><span class="o">]</span>, <span class="m">2281</span><span class="o">)</span>
</pre></div>
<p>Metoda <code class="pyth python"><span class="n">POP3_SSL</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span></code> zwraca status skrzynki w postaci tupli dwóch wartości: ilości wiadomości oraz
rozmiaru skrzynki. Dużo ciekawsza jest <code class="pyth python"><span class="n">POP3_SSL</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>. Zawołana bez żadnego argumentu podaje listę
wiadomości na serwerze. Zawołana z parametrem podaje wiadomość o przekazanym w parametrze numerze.</p>
<p>Spróbujmy odczytać ostatnią wiadomość z listy, funkcją <code class="pyth python"><span class="n">POP3_SSL</span><span class="o">.</span><span class="n">retr</span><span class="p">(</span><span class="n">which</span><span class="p">)</span></code>:</p>
<div class="highlight"><pre><span></span><span class="n">mailbox</span> <span class="o">=</span> <span class="n">poplib</span><span class="o">.</span><span class="n">POP3_SSL</span><span class="p">(</span><span class="n">POP3_SERVER</span><span class="p">,</span> <span class="n">POP3_PORT</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">set_debuglevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">pass_</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">retr</span><span class="p">(</span><span class="n">mailbox</span><span class="o">.</span><span class="n">stat</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span>*cmd* <span class="s1">'USER username@gmail.com'</span>
*cmd* <span class="s1">'PASS ****************'</span>
*cmd* <span class="s1">'RETR 219'</span>
<span class="o">(</span><span class="s1">'+OK message follows'</span>, <span class="o">[</span><span class="s1">'Return-Path: &lt;username1@gmail.com&gt;'</span>, <span class="s1">'Received: from (..) for &lt;username@gmail.com&gt;'</span>,
<span class="s1">'        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);'</span>, <span class="s1">'        Mon, 20 Feb 2017 09:17:30 -0800 (PST)'</span>,
<span class="s1">'Message-ID: &lt;58ab24aa.ce18190a.d70c9.77ee@mx.google.com&gt;'</span>,
<span class="s1">'Date: Mon, 20 Feb 2017 09:17:30 -0800 (PST)'</span>,
<span class="s1">'Content-Type: multipart/mixed; boundary="===============0919153568=="'</span>, <span class="s1">'MIME-Version: 1.0'</span>,
<span class="s1">'TO: usernam@gmail.com'</span>, <span class="s1">'FROM: username1@gmail.com'</span>,
<span class="s1">'Subject: Test'</span>, <span class="s1">'X-Antivirus: Avast (VPS 170220-1, 20.02.2017), Outbound message'</span>, <span class="s1">'X-Antivirus-Status: Clean'</span>, <span class="s1">'X-Antivirus: Avast (VPS 170220-2, 20.02.2017),</span>
<span class="s1">Inbound message'</span>, <span class="s1">'X-Antivirus-Status: Clean'</span>, <span class="s1">''</span>, <span class="s1">'--===============0919153568=='</span>,
<span class="s1">'Content-Type: text/plain; charset="UTF-8"'</span>, <span class="s1">'MIME-Version: 1.0'</span>, <span class="s1">'Content-Transfer-Encoding: quoted-printable'</span>, <span class="s1">''</span>,
<span class="s1">'This is an important message'</span>, <span class="s1">''</span>, <span class="s1">'---'</span>,<span class="o">(</span>...<span class="o">)</span>,<span class="s1">''</span>, <span class="s1">'--===============0919153568=='</span>,
<span class="s1">'Content-Type: image/jpeg'</span>, <span class="s1">'MIME-Version: 1.0'</span>, <span class="s1">'Content-Transfer-Encoding: base64'</span>, <span class="s1">''</span>,
<span class="s1">'/9j/4AAQSkZJRgABAQEBLAEsAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0a'</span>,
<span class="s1">'HBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIy'</span>,
<span class="s1">'MjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAH1AyIDASIA'</span>,
<span class="o">(</span>...<span class="o">)</span>
<span class="s1">'iigAoFFFAB26UdeKKKAE4z0oxRRQAAU09ce9FFAAcA9KTuaKKAEprd6KKAIycDIppHNFFAETDnmo'</span>,
<span class="s1">'nHzYoooArGTBPH60UUUAf//Z'</span>, <span class="s1">'--===============0919153568==--'</span><span class="o">]</span>, <span class="m">133527</span><span class="o">)</span>
*cmd* <span class="s1">'QUIT'</span>
</pre></div>
<p>Ostatnią metodą, o której warto wspomnieć, jest <code class="pyth python"><span class="n">POP3_SSL</span><span class="o">.</span><span class="n">setdebuglevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span></code>. Wywołana z argumentem równym 1 zapewnia,
jak wyżej widać, średni poziom logowania. Natomiast z argumentem równym 2 lub większym zapisuje całą komunikację odbywającą
się na połączeniu kontrolnym:</p>
<div class="highlight"><pre><span></span><span class="n">mailbox</span><span class="o">.</span><span class="n">set_debuglevel</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">pass_</span><span class="p">(</span><span class="n">APP_PASSWORD</span><span class="p">)</span>
<span class="n">mailbox_status</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
<div class="highlight"><pre><span></span>*cmd* <span class="s1">'USER usernam@gmail.com'</span>
*put* <span class="s1">'USER username@gmail.com'</span>
*get* <span class="s1">'+OK send PASS\r\n'</span>
*resp* <span class="s1">'+OK send PASS'</span>
*cmd* <span class="s1">'PASS ****************'</span>
*put* <span class="s1">'PASS ****************'</span>
*get* <span class="s1">'+OK Welcome.\r\n'</span>
*resp* <span class="s1">'+OK Welcome.'</span>
*cmd* <span class="s1">'STAT'</span>
*put* <span class="s1">'STAT'</span>
*get* <span class="s1">'+OK 219 204595639\r\n'</span>
*resp* <span class="s1">'+OK 219 204595639'</span>
*stat* <span class="o">[</span><span class="s1">'+OK'</span>, <span class="s1">'219'</span>, <span class="s1">'204595639'</span><span class="o">]</span>
*cmd* <span class="s1">'QUIT'</span>
*put* <span class="s1">'QUIT'</span>
*get* <span class="s1">'+OK Farewell.\r\n'</span>
*resp* <span class="s1">'+OK Farewell.'</span>
</pre></div>
</div>
<div class="section" id="imap">
<h2>IMAP</h2>
<p>W odróżnieniu od POP3, IMAP nie wymaga ściągnięcia wszystkich wiadomości na komputer lokalny. Transmitowane są jedynie
same nagłówki wiadomości, treść i załączniki przesyłane są na żądanie użytkownika. IMAP, poza pobraniem wiadomości,
pozwala na wykonywanie wielu innych operacji, jak tworzenie i zarządzanie katalogami czy kasowanie wiadomości bez konieczności
ich otwierania.</p>
<p>Przykładowa sesja z użyciem protokołu IMAP może wyglądać tak:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">imaplib</span>

<span class="n">IMAP_SERWER</span> <span class="o">=</span> <span class="s1">'imap.googlemail.com'</span>
<span class="n">IMAP_PORT</span> <span class="o">=</span> <span class="s1">'993'</span>
<span class="n">USER_NAME</span> <span class="o">=</span> <span class="s1">'username@gmail.com'</span>
<span class="n">APP_PASSWORD</span> <span class="o">=</span> <span class="s1">'****************'</span>

<span class="n">mailbox</span> <span class="o">=</span> <span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4_SSL</span><span class="p">(</span><span class="n">IMAP_SERWER</span><span class="p">,</span> <span class="n">IMAP_PORT</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="mi">0</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="n">APP_PASSWORD</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'Inbox'</span><span class="p">)</span>
<span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'ALL'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
    <span class="n">ms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="s1">'RFC822'</span><span class="p">))</span>
    <span class="nb">print</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">'+FLAGS'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">Seen'</span><span class="p">)</span>

<span class="n">mailbox</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
</pre></div>
<p>Jest to prosty program wypisujący zawartość wszystkich wiadomości w skrzynce odbiorczej a następnie oznaczający je jako przeczytane.
Tak, jak przy POP3, zaczynamy od
utworzenia szyfrowanego połączenia i, analogicznie do poprzednich przykładów, uwierzytelniamy się adresem email oraz 'App password'.
Następnie funkcją <code class="pyth python"><span class="n">IMAP4_SSL</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">mailbox</span><span class="o">=</span><span class="s1">'INBOX'</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code> wybieramy skrzynkę, z którą chcemy pracować. Domyślnie są to wiadomości odebrane,
natomiast nic nie stoi na przeszkodzie, by wybrać np. utworzony w ramach konta pocztowego folder.
<code class="pyth python"><span class="n">IMAP4_SSL</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">)</span></code> umożliwia przeszukiwanie skrzynki wg zadanych kryteriów, np. <code class="pyth python"><span class="n">search</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'(FROM "admin" SUBJECT "Warning")'</span></code>.
Parametry polecenia <strong>SEARCH</strong> można znaleźć w <a class="reference external" href="https://tools.ietf.org/html/rfc3501#section-6.4.5">RFC3501</a>.
Potem <code class="pyth python"><span class="n">IMAP4_SSL</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">message_set</span><span class="p">,</span> <span class="n">message_parts</span><span class="p">)</span></code> pobiera wskazane elementy wiadomości. W naszym przypadku jest to cała wiadomość,
tak, jak jest zdefiniowana w RFC822. Można oczywiście pobrać część wiadomości, np. poniższy kod pobiera same nagłówki:
<code class="pyth python"><span class="n">fetch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">'(BODY.PEEK[HEADER])'</span><span class="p">)</span></code>. Więcej na temat polecenia <strong>FETCH</strong> można znaleźć we wspomnianym <a class="reference external" href="https://tools.ietf.org/html/rfc3501#section-6.4.5">RFC3501</a>.
Na koniec funkcją <code class="pyth python"><span class="n">IMAP4_SSL</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">message_set</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span></code> ustawiamy na wiadomościach flagę 'Seen' - wiadomości
zostają oznaczone jako przeczytane. Listę dostępnych flag jest opisana <a class="reference external" href="https://tools.ietf.org/html/rfc3501.html#section-2.3.2">tu</a>.
Oczywiście flagi można też zdejmować. Przykładowo, wystarczy użyć '-FLAGS' zamiast
'+FLAGS': <code class="pyth python"><span class="n">ms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">'-FLAGS'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">Seen'</span><span class="p">)</span></code>, by wiadomość oznaczyć jako nieprzeczytaną.</p>
<p>Jak już wspomniałem, IMAP daje dużo większe możliwości niż POP3. Możemy, na przykład, pobrać same załączniki w formacie
jpeg z wybranych wiadomości:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">imaplib</span>
<span class="kn">import</span> <span class="nn">email</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="n">IMAP_SERWER</span> <span class="o">=</span> <span class="s1">'imap.googlemail.com'</span>
<span class="n">IMAP_PORT</span> <span class="o">=</span> <span class="s1">'993'</span>
<span class="n">user_name</span> <span class="o">=</span> <span class="n">USER_NAME</span>
<span class="n">APP_PASSWORD</span> <span class="o">=</span> <span class="s1">'****************'</span>

<span class="n">mailbox</span> <span class="o">=</span> <span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4_SSL</span><span class="p">(</span><span class="n">IMAP_SERWER</span><span class="p">,</span> <span class="n">IMAP_PORT</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">USER_NAME</span><span class="p">,</span> <span class="n">APP_PASSWORD</span><span class="p">)</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'Inbox'</span><span class="p">)</span>
<span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'(FROM "me" Subject "Photo")'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
    <span class="n">ms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="s1">'(RFC822)'</span><span class="p">))</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'image/jpeg'</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="o">+</span> <span class="s1">'.jpg'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">'+FLAGS'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">Seen'</span><span class="p">)</span>

<span class="n">mailbox</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">mailbox</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
</pre></div>
<p><code class="pyth python"><span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span></code> parsuje string na obiekt typu <code class="pyth python"><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span></code> dający
interfejs do zarządzania nagłówkami i treścią wiadomości. <code class="pyth python"><span class="n">Message</span><span class="o">.</span><span class="n">walk</span><span class="p">()</span></code> jest generatorem umożliwiającym
iterację poprzez kolejne części wiadomości, w naszym przypadku szukamy elementów typu 'image/jpeg'. Wreszcie, metodą
<code class="pyth python"><span class="n">Message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">i</span><span class="p">[,</span> <span class="n">decode</span><span class="p">])</span></code> pobieramy zawartość załącznika. By uniknąć konfliktów nazw, plik(i)
zapisujemy pod unikalnymi nazwami będącymi ID zwracanymi przez <code class="pyth python"><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span></code></p>
</div>
<div class="section" id="wysylanie-logow-mailem">
<h2>Wysyłanie logów mailem</h2>
<p>Moduł <code class="pyth python"><span class="n">logging</span></code> dostarcza bardzo użyteczny handler umożliwiający łatwe wysyłanie wiadomości z logów na
podane adresy email: <code class="pyth python"><span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">(</span><span class="n">mailhost</span><span class="p">,</span> <span class="n">fromaddr</span><span class="p">,</span> <span class="n">toaddrs</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging.handlers</span>

<span class="n">SMTP_SERVER</span> <span class="o">=</span> <span class="s1">'smtp.gmail.com'</span>
<span class="n">SMTP_PORT</span> <span class="o">=</span> <span class="mi">587</span>
<span class="n">APP_PASSWORD</span> <span class="o">=</span> <span class="s1">''</span>
<span class="n">FROM</span> <span class="o">=</span> <span class="s1">'from@gmail.com'</span>
<span class="n">TO</span> <span class="o">=</span> <span class="s1">'to@gmail.com'</span>
<span class="n">SUBJECT</span> <span class="o">=</span> <span class="s1">'Important message from logging system'</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">((</span><span class="n">SMTP_SERVER</span><span class="p">,</span> <span class="n">SMTP_PORT</span><span class="p">),</span> <span class="n">FROM</span><span class="p">,</span> <span class="n">TO</span><span class="p">,</span> <span class="n">SUBJECT</span><span class="p">,</span> <span class="p">(</span><span class="n">FROM</span><span class="p">,</span> <span class="n">APP_PASSWORD</span><span class="p">),</span> <span class="n">secure</span><span class="o">=</span><span class="p">())</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">"</span><span class="si">%(asctime)-15s</span><span class="s2"> </span><span class="si">%(levelname)-5s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">"</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Some usefull message"</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"There is a big error"</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Just ordinary info"</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
<p>Parametr <code class="pyth python"><span class="n">mailhost</span></code> może być stringiem z adresem serwera SMTP - użyty będzie wtedy domyślny port lub tuplą z
adresem serwera i portem. Parametr <code class="pyth python"><span class="n">toaddrs</span></code> zawiera listę adresatów oddzieloną przecinkami. Jeśli serwer wymaga
autoryzacji, do <code class="pyth python"><span class="n">credentials</span></code> przekazujemy login i hasło. Wreszcie, by skorzystać z TLS, trzeba do parametru
<code class="pyth python"><span class="n">secure</span></code> przekazać krotkę: pustą lub z nazwą klucza lub nazwą klucza i certyfikatem.</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="http://github.com/kwitkowicz"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="/posts/2020/04/07/value-bad.html">Dlaczego @Value to zło</a></li>
    <li class="list-group-item"><a href="/posts/2017/08/20/lseek.html">lseek</a></li>
    <li class="list-group-item"><a href="/posts/2017/06/07/errno.html">O problemach z errno słów kilka</a></li>
    <li class="list-group-item"><a href="/posts/2017/03/14/rpi-lkm-part-3.html">Raspberry Pi: moduły jądra - część 3</a></li>
    <li class="list-group-item"><a href="/posts/2017/03/01/email-python.html">Email w pythonie</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group " id="tags">
    <li class="list-group-item tag-1">
      <a href="/tag/raspberry-pi.html">raspberry pi</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="/tag/kernel.html">kernel</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="/tag/c.html">c</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/linux.html">linux</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/email.html">email</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/python.html">python</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/java.html">java</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/spring-boot.html">spring-boot</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/spring.html">spring</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://getpelican.com/" target="_blank">Pelican</a>
    </li>
    <li class="list-group-item">
      <a href="http://python.org/" target="_blank">Python.org</a>
    </li>
    <li class="list-group-item">
      <a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Krzysiek Witkowicz
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.polish"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.polish">Creative Commons Attribution-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>




</body>
</html>